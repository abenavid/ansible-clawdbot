---
# Linux-specific Tailscale installation (RedHat family: RHEL, CentOS, Rocky, Alma)

- name: Add Tailscale repository (RedHat family)
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      RHEL_VER="$(rpm -E %rhel)"
      curl -fsSL "https://pkgs.tailscale.com/stable/rhel/${RHEL_VER}/tailscale.repo" | \
        tee /etc/yum.repos.d/tailscale.repo > /dev/null
    creates: /etc/yum.repos.d/tailscale.repo
    executable: /bin/bash

- name: Install Tailscale (RedHat family)
  ansible.builtin.dnf:
    name: tailscale
    state: present
    update_cache: true

- name: Enable Tailscale service (RedHat family)
  ansible.builtin.systemd:
    name: tailscaled
    enabled: true
    state: started

- name: Check if Tailscale is already connected (RedHat family)
  ansible.builtin.command: tailscale status --json
  register: tailscale_status_redhat
  changed_when: false
  failed_when: false

- name: Display Tailscale auth URL if not connected (RedHat family)
  ansible.builtin.debug:
    msg:
      - "============================================"
      - "Tailscale installed but not connected yet"
      - "============================================"
      - ""
      - "To connect this machine to your Tailnet:"
      - "Run: sudo tailscale up"
      - ""
      - "For unattended installation, use an auth key:"
      - "sudo tailscale up --authkey tskey-auth-xxxxx"
      - ""
      - "Get auth key from: https://login.tailscale.com/admin/settings/keys"
  when: tailscale_status_redhat.rc != 0

